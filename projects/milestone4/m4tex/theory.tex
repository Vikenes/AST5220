\subsection{Theory}\label{ssec:M4:theory}
In this section, we begin by introducing the general theory behind how the CMB power spectrum is computed. Using these equations, we will derive some approximate results that relates to general features we expect to see. Based on this initial understanding of the power spectrum, a more detailed discussion is presented when discussing the results in \secref{ssec:M4:results}.      

\subsubsection{Angular power spectrum} \label{sssec:M4:theory:angular_power_spectrum}
The temperature fluctuations can be expanded in spherical harmonics as
\begin{equation} \label{eq:M4:theory:theta_expansion_in_spherical_harmonics}
    \Theta(\vec{x}, \hat{\vec{p}}, t) = \sum_{\ell=1}^{\infty} \sum_{m=-\ell}^{\ell} a_\lm(\vec{x}, t) Y_\lm(\hat{\vec{p}}), 
\end{equation}
where the amplitudes, $a_\lm$, contain all the information about the temperature field, and are to be evaluated at our position in the Universe at $t=t_0$. However, we are unable to make prediction about particular values of these amplitudes, as inflation is a stochastic process. Since inflation predicts $\Theta$ to be very close to Gaussian, each $a_\lm$ is therefore drawn from a normal distribution with zero mean and a variance given as 
\begin{equation} \label{eq:M4:theory:variance_of_alms}
    \expval{a_\lm a_\lmp} = \delta_{\ell \ell'} \delta_{m m'} \cl,
\end{equation} 
where the brackets denote an ensemble average. 

We follow the approach of \cite[Ch. 9.5]{Dodelson}, leaving out the details of the derivation. We now omit factors of $t$ in the expressions, as we are only concerned with the value at $t=t_0$, and obtain   
\begin{equation} \label{eq:M4:theory:C_ell_integral_definition}
    \cl = 4\pi \int \P_\R (k) \abs{\Theta_\ell\code(k)}^2 \,\frac{\dd k}{k},
\end{equation}
where we have used $\Theta_\ell(\vec{k})= \Theta_\ell\code(k) \R\ini$, where $\R\ini\propto\Psi$ comes from inflation. This rescaling accounts for the fact that we have set $\Psi=-2/3$ as our initial condition when solving the perturbation ODEs numerically. $\P_\R(k)$ is related to the primordial power spectrum, $P(k)$, via 
\begin{equation} \label{eq:M4:theory:primordial_power_spectrum_}
    P(k) = \frac{2\pi^2}{k^3}\P_\R(k),
\end{equation}
where $\expval{\R\ini(\vec{k}) \R\ini^*(\vec{k}')}=(2\pi^2)\delta(\vec{k}-\vec{k}') P(k)$. To compute $\cl$, the last thing we need is an expression for $\P_\R(k)$. We get an expression for this from the fact that most inflationary models predict a so-called Harrison-Zel'dovich spectrum, 
\begin{equation} \label{eq:M4:theory:primordial_power_spectrum}
    \P_\R(k) = \as \pclosed{\frac{k}{\kp}}^{\ns-1}, 
\end{equation}
where $\as$ is the primordial amplitude, $\kp$ is the scale where the amplitude of $\P_\R(k)$ is $\as$, and $\ns$ is the spectral index, determining how perturbations at different scales are affected by inflation. For $\ns=1$ perturbations are scale invariant, whereas we have $\ns=0.965$, meaning that the power spectrum will be tilted to give an increased amplitude on larger scales.   

Thus, the final expression we want to compute is 
\begin{equation} \label{eq:M4:theory:CMB_power_spectrum}
    \cl = 4\pi \int_0^\infty \as \pclosed{\frac{k}{\kp}}^{\ns-1} \Theta_\ell^2(k) \, \frac{\dd k}{k}.
\end{equation}

\subsubsection{Matter power spectrum} \label{sssec:M4:theory:matter_power_spectrum}
From the Fourier components of the matter overdensity field, we can compute the matter power-spectrum
\begin{equation} \label{eq:M4:theory:MatterPS_of_x_k}
    P_L(k,x) = \abs{\Delta_M(k,x)}^2,\quad \text{where}\quad \Delta_M(k,x) \equiv \frac{k^2 \Phi(k,x)}{\frac{3}{2}\omn e^{-x} H_0^2}.
\end{equation}
Once again, we have to take rescale $\Delta_M$ to account for our choice of initial conditions. Taking the value today, we thus want to compute 
\begin{equation} \label{eq:M4:theory:MatterPS_code_today}
    \plk = \abs{\Delta_M\code(k)}^2 P(k) = \abs{\Delta_M\code(k)}^2\, \frac{2\pi^2}{k^3} \as \pclosed{\frac{k}{\kp}}^{\ns-1}.
\end{equation}
The shape of $\plk$ is naturally divided into three regions. On small scales, modes enter the horizon during radiation domination, where the growth of perturbations is suppressed due to photon pressure. On larger scales, modes entering the horizon in the matter dominated era, or later, are not affected by this suppression. In between these two regimes, we expect there to be a scale $\keq$, where $\plk$ peaks. This equality scale is $\keq\equiv\H(x_\mathrm{eq})$. From \citeauthor{Baumann} (Ch. 5.2.3), we find the asymptotic behaviour of $\plk$ as
\begin{equation} \label{eq:M4:theory:matter_power_spectrum_asymptotic_scaling}
    \plk \propto \begin{cases}
        k^{\ns}     ,&\quad k<\keq, \\
        k^{-3},&\quad k>\keq, 
    \end{cases}
\end{equation}  
which encodes the physical differences of how different modes grow.   


\subsubsection{Line-of-sight integration}\label{sssec:M4:theory:line_of_sight_integration}
As mentioned in \secref{sssec:M3:theory:perturbation_equations}, we compute higher order multipoles from the LOS approach. 
\begin{equation} \label{eq:M4:theory:Theta_ell_LOS_integration}
    \Theta_\ell(k,x=0) = \int_{-\infty}^0 \tilde{S}(k,x) j_\ell [k(\eta_0 - \eta(x))]\,\dd x, 
\end{equation}
where $\jell(k(\eta_0-\eta(x)))$ is the spherical Bessel function. $\tilde{S}(k,x)$ is the source function, which is given by 
\begin{equation} \label{eq:M4:theory:source_function_LOS}
    \begin{split}
        \tilde{S}(k,x) =& \g \bclosed{\Theta_0 + \Psi + \frac{1}{4} \Pi} + e^{-\tau}\bclosed{\Psi' - \Phi'} \\
        & - \frac{1}{k}\dv{x}(\H \g \vb) + \frac{3}{4k^2}\dv{x}\bclosed{\H \dv{x}(\H\g\Pi)},
    \end{split}
\end{equation}
where $\Pi=\Theta_2$.

In order to gain insight into the impact of different physical effects on the power spectrum, we can examine the individual components of the source function. We will provide such an analysis of the individual components of $S(k,x)$, and their resulting $\cl$, in \secref{sssec:M4:results:angular_power_spectrum}. Before delving into those details, we begin by presenting a general overview of each term in the next section.

\subsubsection{Physics behind the LOS integral} \label{sssec:M4:theory:physics_behind_the_LOS_integral}
The main physical idea behind the LOS approach, is that light observed in a given direction from the CMB today, is directly related to the CMB monopole along the LOS from us to infinity. The four terms in the source function represent different physical effects, with the first two being the so-called Sachs-Wolfe (SW) term and the integrated Sachs-Wolfe (ISW) effect. As we will see later, SW is the dominant contributor to $\cl$, so we neglect the other terms for now. Since $\g$ is a sharply peaked at recombination, we may approximate it as a delta function, giving 
\begin{equation} \label{eq:M4:theory:Theta_ell_today_SW_approximation}
    \begin{split}
        \Thl\tday(k)&\approx \bclosed{\Thn + \Psi + \Theta_2/4}\rec\cdot j_\ell(k(\eta_0-\eta\rec)) \\ 
        &\approx\bclosed{\Thn + \Psi}\rec\cdot j_\ell(k\eta_0) , 
    \end{split}
\end{equation}
where we have used $\eta\rec\ll\eta_0$, and the fact that $\Theta_2\ll\Thn$ at recombination. The quantity $\Thn+\Psi$ represents an effective photon temperature. As the decoupled photons travel freely towards us today, they are gravitationally redshifted by the potential, $\Psi$. Hence, the SW term is an effective photon temperature with a tiny quadrupole correction. The anisotropies observed in the power spectrum today originate from temperature irregularities that existed during recombination. These irregularities were frozen in during the decoupling process, and serve as indicators of the underlying physics prior to photon decoupling.

From the approximation in \Eqref{eq:M4:theory:Theta_ell_today_SW_approximation}, we see that $\Thl\propto\jell(k\eta_0)$. Since $\jell(x)$ has a peak at $x\sim\ell$, we expect $\Thl(k)$ to have a peak at $k\sim\ell/\eta_0$. On small angular scales, the spherical Bessel function can be approximated as \cite[Eq. (9.61)]{Dodelson}
\begin{equation}
    \jell(x) \xrightarrow{x/\ell\to0} \frac{1}{\ell}\pclosed{\frac{x}{\ell}}^{\ell-1/2},
\end{equation} 
so when $x<\ell$, i.e. $k\eta_0<\ell$, the spherical Bessel function is heavily suppressed. Consequently, the power spectrum at a particular $\ell$ receives minimal contribution from larger-scale modes where $k<\ell/\eta_0$. This behaviour can be easily understood from a physical perspective, as we anticipate limited anisotropy on small angular scales arising from perturbations characterized by large wavelengths. On the other hand, for angular scales $\ell<1/(k\eta_0)$, there is also a negligible contribution to the photon multipole from $\jell$. Thus, following \Eqref{eq:M4:theory:CMB_power_spectrum}, we may expect perturbation features on scales $k$ to be mapped onto angular scales of $\ell\sim k\eta_0$ in $\cl$. In \secref{sssec:M4:results:photons_multipoles} we will see an example of how various $\ell$-values depend on $k$.   

The ISW represents the fact that gravitational potentials may change in time as photons move through it. For freely moving photons entering gravitational potentials, there is no net change in temperature if the potentials remain constant in time. Photons entering a gravitational potential gets an energy change that is cancelled out by the energy change it experiences when it leaves the gravitational potential again, if the potential remains constant in time. The potentials are also weighted by a factor $e^{-\tau}$, so we only get a contribution from this term after recombination. Modes decaying after recombination are therefore expected to yield a noticeable ISW effect. From \figref{fig:M3:results:Phi}, we may expect contributions from intermediate scale modes on intermediate angular scales. On large scales, when the Universe starts accelerating, the potentials decay. With a low value of $\tau$, on these scales we also expect contributions to $\cl$ from the largest angular scales, i.e. at low $\ell$.  

The third term in \Eqref{eq:M4:theory:source_function_LOS} is effectively a dipole term, since $\vb\sim\vg$ at early times. From our discussion of the evolution of the monopole and dipole, in \figref{fig:M3:results:deltas} and \ref{fig:M3:results:vels}, we can expect the dipole term to contribute on scales that had entered the horizon before decoupling. Additionally, with $\Theta_0$ and $\Theta_1$ being out of phase, we expect anisotropies from this term to be out of phase with anisotropies of the SW as well. The final term is a quadrupole term, and is related to the angular dependence of Thompson scattering. However, as we will see in \secref{ssec:M4:results}, this term gives a very small contribution.

An important aspect of $\cl$, is its behaviour at large scales. If the ISW contribution is ignored, for low $l$, we have $(\Thn + \Psi)\rec\approx(\Thn + \Psi)\ini$, since the large scale modes have not entered the horizon before decoupling. The SW term is therefore approximately given as $\Thl\approx (\Thn + \Psi)\ini j_\ell(k\eta_0)$. Substituting $x=k\eta_0$, the integral in \Eqref{eq:M4:theory:CMB_power_spectrum} for $\ns=1$ becomes 
\begin{equation} \label{eq:M4:theory:C_ell_SW_plateau_integral}
    \begin{split}
        \cl &= 4\pi \as \abs{(\Thn+\Psi)\ini}^2 \frac{1}{(\kp \eta_0)^{\ns-1}} \int_0^\infty \dd\, x j_\ell^2(x) x^{\ns-2}, \\
        \implies& \frac{\ell(\ell+1)}{2\pi}\cl = \as \abs{(\Thn+\Psi)\ini}^2 = \text{constant}.   
    \end{split}
\end{equation}
When plotting the CMB power spectrum, we will plot the RHS of \Eqref{eq:M4:theory:C_ell_SW_plateau_integral} against $\ell$ in units of $\mathrm{\mu K^2}$, which is then expected to be roughly constant. We have $\ns=0.965<1$, so we have $\ell(\ell+1)\cl\propto \ell^{\ns-1}$, which will induces a small tilt at low $\ell$. The ISW will also result in a further deviation from a constant value. 


