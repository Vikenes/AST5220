\subsection{Results}\label{ssec:M4:results}
The resulting CMB power spectrum we obtain provides vital information on the main cosmological parameters we use today. We will briefly discuss some parameter dependencies when relevant for the results we obtain. However, having mostly used the latest Planck values for the cosmological parameters, we will not discuss consequences of parameter adjustments in detail. With several degeneracies in this multidimensional parameter space makes it difficult to make detailed conclusions of parameter dependency, without explicit computations, which is too time-consuming to do at the moment.  

\subsubsection{CMB power spectrum} \label{sssec:M4:results:angular_power_spectrum}
We begin our analysis by qualitatively explaining the most prominent features of the power spectrum. In particular, we make frequent use of \Eqref{eq:M4:theory:Theta_ell_today_SW_approximation}, which offers as a simple way for gaining an initial understanding of the main features we observe in the power spectrum. We limit our initial discussion to only include effects that may be understood from the SW term mostly. After this initial discussion, we will explore the physics behind the results in greater detail.

The angular power spectrum is shown in \figref{fig:M4:results:peaks_and_troughs_cells}, where vertical lines have been drawn to mark the position of the peaks (red) and troughs (blue). We include data from \cite{Planck2020} for low $\ell$ values. At higher $\ell$, neutrinos, helium and reionization becomes important, and our prediction of $\cl$ at small scales would deviate from that of observations. 

The peaks we observe in the power spectrum result from the oscillations in the photon baryon plasma, seen in \secref{ssec:M3:results}. Modes enter the horizon at different times, depending on their size, which affects the state of the plasma when the photons decouple. If the plasma is fully compressed upon recombination, the photons have to escape from deep potential wells, and will therefore be redshifted. Similarly, if a mode is fully decompressed at recombination, the photons are less redshifted as they escape the potential wells. Both of these extrema will result in a relatively large temperature inhomogeneity. Since $\cl$ depends on the absolute value of the photons multipoles, these extrema shows up as the peaks of the power spectrum. The troughs therefore correspond to modes for which the temperature perturbation is approximately zero. This will therefore occur when the oscillation is at its mean value, in between the extrema.     

As seen in \secref{ssec:M3:results}, the size of the modes strongly affect their behaviour before decoupling. Small scale modes will undergo several oscillations before recombination occurs. The number of oscillations a mode undergoes before decoupling decreases for larger scale modes, and for modes larger than the horizon during recombination, we expect no oscillations to take place. Thus, the peak at $\ell=205$ corresponds to a mode that just began to oscillate, with recombination taking place when it was at its maximum. As $\ell$ is decreased from $205$, the modes are gradually less compressed, until we reach scales of modes that had not entered the horizon before decoupling. On the largest angular scales, we see a manifestation of \Eqref{eq:M4:theory:C_ell_SW_plateau_integral}, as the power spectrum is roughly constant, as expected. 
\begin{figure}[ht!]
    \includefig{peaks_and_troughs_cells\pspecresolution}
    \caption{The predicted CMB power spectrum (black) compared with data from Planck at large scales. \note{Fix y-label. Should indicate $\tcmb$}}
    \label{fig:M4:results:peaks_and_troughs_cells}
\end{figure}

To see that the peaks and troughs in \figref{fig:M4:results:peaks_and_troughs_cells} actually correspond to modes where $\Thn$ is at extrema, we plot $\Thn(k,x)$ as a function of $x$ for $k=\lp/\etan$ and $k=\lt/\etan$, shown in \figref{fig:M4:results:theta0_at_peaks_and_troughs}. We also mark the region of $x\sim x\rec$. As evident from the figure, the first three peaks of $\cl$ correspond to modes on scales that are at maxima. The troughs occur at scales that are essentially zero deviation from the initial temperature perturbation. Modes with wavenumber $k\sim\lt/\etan$ give roughly zero contribution to the power spectrum, but modes with different wavenumbers give a non-zero contribution to the power spectrum, effectively lifting the troughs. 

Another important feature, is that the maxima of $\Thn(x)$ in the upper panel of \figref{fig:M4:results:theta0_at_peaks_and_troughs} don't occur at $x=x\rec$. In general, inhomogeneities on scale $k$ contributes to $\cl$ at slightly lower value of $\ell$ than $\ell=k\eta_0$. One reason for this, is that $\jell(x)$ peaks when $\ell$ is slightly smaller than $x$. 
\begin{figure}[ht!] 
    \includefig{Theta0_at_peaks_and_troughs}
    \caption{Computed monopoles for of scale $k=\ell/\eta_0$ for different values of $\ell$. The upper panel are $\ell$ values where the power spectrum peaks, and the lower panel are the $\ell$ values of the power spectrum troughs.}
    \label{fig:M4:results:theta0_at_peaks_and_troughs}
\end{figure}

The next prominent feature in \figref{fig:M4:results:peaks_and_troughs_cells} are the damping of the peaks at small scales. During tight coupling, photons and baryons do not behave exactly as one fluid. In reality, photons travel a certain distance between scattering events, essentially performing random walks. During a Hubble time $H^{-1}$, a photon will scatter $N=\abs{\tau'}=n_e \sigma_T / H$ times. With a mean free path of $\mfp=1/n_e \sigma_T$ for Thomson scattering, the mean distance a photon travels during a Hubble time is 
\begin{equation}
    \lambda_D = \mfp \sqrt{N} = 1 / \sqrt{n_e \sigma_T H},
\end{equation}
On scales smaller than $\ld$, scattering has the effect of smoothing the temperature fluctuations, since photons diffuse over such a region, causing the region to have a single mean temperature. In phase space, this corresponds to a damping on small scales $k_D\gtrsim 2\pi/\ld$. Although recombination is not an instantaneous process, it does occur relatively fast. There will be some random walks undertaken by photons as they decouple, but they will very rapidly start streaming in straight lines as $\ne$ eventually becomes very small. For a mode with wavelength much larger than $\ld$, an observer would measure photons coming in from all directions from a distance $\lambda\sim\mfp$, over which the temperature hardly varies. Thus, larger angular scales are not affected by diffusion of photons. 

Diffusion explains the damping at large $\ell$, and also helps us understand why the first peaks have much larger amplitudes than the others, as damping has a decreasing effect on larger scales. The peak at $\ell=205$ is hardly affected at all, whereas the third experiences some damping effect, although not noticeable, since it is counteracted by another effect, as we explain later. The second peak experiences some damping, but the same effect that counteracts suppression of the third peak also induces significant suppression of the second peak. In addition to damping of higher peaks, there is an important effect which amplifies the peaks. The potentials of modes entering the horizon before matter domination, will decay, as seen in \figref{fig:M3:results:Phi}. This will amplify peaks when potentials decay during a compression phase, since the photon no longer has a potential to overcome upon escaping. Amplification on smaller scales is not sufficient to fully overcome diffusion on small scales, as the latter is an exponential suppression. Note that potential decaying affects the SW term as well as the ISW term. In \figref{fig:M3:results:Phi}, we see that the intermediate mode has a decaying potential when $\tau\gg1$, and a potential that is almost constant when $\tau\lesssim1$, which yields a negligible ISW effect. This decay however, will affect the effective photon temperature at decoupling.    

We mentioned that the third peak is higher than the second peak, as opposed to the higher peaks, which are generally lowered at higher $\ell$. This follows a general trait, namely that the odd numbered peaks are enhanced relative to the even peaks. Odd numbered peaks are caused by compressions, which occur when the baryon photon plasma falls into the gravitational wells set up by the CDM. However, as baryons fall into these potential wells, they will effectively make the potential well deeper. As a result, photons escaping from these potential wells during decoupling gets a further decrease in their effective temperature.     

\subsubsection{Contribution from individual components} \label{sssec:M4:results:contribution_from_individual_components}
In \figref{fig:M4:results:cells_components}, we plot the power spectrum obtained from the four individual terms in \Eqref{eq:M4:theory:source_function_LOS}. Note that the quadrupole term is non-zero, but has a negligible contribution to power spectrum compared to the other terms. It can be seen on a logarithmic scale, but we choose a linear scale to better understand how the other terms contribute to the overall power spectrum. We emphasize that the four individual terms in \figref{fig:M4:results:cells_components} don't sum up to $\cl$, since cross terms in $\Thl^2$ are missing. The cross terms play an important role, and we can infer some of its implications from the isolated contributions alone.     

The SW term is the dominant contribution to $\cl$, which justifies the choice of considering this term only for the discussion in the previous subsection. The second most dominant term is the Doppler term. On the largest scales, $\Theta_1\simeq 0$, since these modes have not entered the horizon prior to decoupling, resulting in decreasing contribution at lower $\ell$. On smaller scales, we see that the dipole raises the overall spectrum, but it does so more for the troughs than the peaks. This is due to the monopole and dipole being out of phase, and the dipole therefore reduces the prominence of the peaks in the power spectrum. We previously argued that the troughs are non-zero due to non-zero monopole contributions from several modes. This argument still holds, as seen from the SW line in \figref{fig:M4:results:cells_components} (green line), but the dipole induces a considerable lifting of the troughs. Hence, the dipole term means that the contribution from a single mode will result in a non-zero trough.   

The final main contributor to the power spectrum is the ISW term. As expected, it gives a contribution at low $\ell$. Modes entering the horizon after decoupling have approximately constant potentials initially. As dark energy begins to dominate, the Universe begins accelerating, causing the potentials to decay, as seen from \figref{fig:M3:results:Phi}. These modes give a contribution to $\cl$ at low $\ell$, and are referred to as the late time ISW effect. There is also a noticeable contribution at intermediate scales, known as the early ISW. The transition from radiation domination to pure matter domination is not an abrupt process, and radiation energy density is not completely negligible after recombination, as seen from \figref{fig:M1:results:omega_i_of_x}. For modes where this decay lasts until $\tau\simeq1$, we get a noticeable ISW effect.   
\begin{figure}[ht!]
    \includefig{cells_components\pspecresolution}
    \caption{The total angular power spectrum (dashed blue curve), compared to power spectra computed from individual terms in \Eqref{eq:M4:theory:source_function_LOS}. For each term in the figure, the remaining terms in \Eqref{eq:M4:theory:source_function_LOS} have been set to zero.}
    \label{fig:M4:results:cells_components}
\end{figure}

The ISW appears to have a relatively small contribution to $\cl$, compared to the dipole term. However, there is an important contribution coming from cross terms that we have ignored. In \figref{fig:M4:results:cells_components}, we see that the ISW contribution is in phase with the SW contribution. The dipole on the other hand is out of phase with the SW term. The relative contribution from ISW to $\cl$ is therefore stronger than that from the dipole term.   


\subsubsection{Matter power spectrum} \label{sssec:M4:results:matter_power_spectrum}
The matter power spectrum is plotted in \figref{fig:M4:results:matterPS_nk2000Neff}. For comparison, we have included the result obtained from not having $\neff=0$ in the background. This affects $\keq$, as well as the value of $\Phi$, since $\H$ is slightly altered by including neutrinos. We have not accounted for neutrinos when solving the perturbation ODEs, so this approach should only be taken as a highly approximate way of studying how neutrinos affect $\plk$. 

The behaviour of $\plk$ follows that of \Eqref{eq:M4:theory:matter_power_spectrum_asymptotic_scaling}. There is a noticeable discrepancy between the predicted value of $\plk$ compared to that from data at high $k$. This regime is related to growth of perturbations on small scales, and is thus affected by the radiation at early times. Comparing with the prediction where neutrinos are included, we get a reduction of $\plk$ on small scales, differing from the data by roughly the same magnitude. This does, nonetheless, seem reasonable. When neutrinos are ignored completely, matter domination begins earlier. Modes inside the horizon grows as $\Delta_M\propto\log(a)$ during radiation domination, while they grow as $\Delta_M\propto a$ during matter domination. Thus, small scale modes have been able to grow more, resulting in the difference between the predicted value of $\plk$, in blue, and the observational data. 

At small scales we also notice oscillating behaviour of $\plk$. Before recombination, photons exert pressure on the baryons, dragging them outwards from the CDM potential wells. When photons eventually decouple, there is an excess of baryons around a spherical shell of the sound horizon, $r_s$, which is how far the baryons have been able to travel. Most of the baryons will follow the CDM, but a region of excess baryons will remain in place, starting to attract CDM as well. This clustering around $r_s$, caused by the photons, translates to oscillations in Fourier space, as seen in the low $k$ end in $\plk$. 
\begin{figure}[ht!]
    \includefig{matterPS_nk2000Neff}
    \caption{Computed matter power spectrum (solid blue curve), compared with observational data from \note{cite}. The equality scale, $\keq$, is marked as the vertical black line.}
    \label{fig:M4:results:matterPS_nk2000Neff}
\end{figure}





\subsubsection{Photon multipoles} \label{sssec:M4:results:photons_multipoles}
The transfer function, $\Thl\code(k)$, and the integrand term of $\cl$, $\Thl^2/k$, is plotted for different values of $\ell$, shown in \figref{fig:M4:results:integrand_thetas} and \figref{fig:M4:results:thetas}, respectively. We stress that the files have been stored with a sampling of $N=2000$ values of $k$, which is less than $10\,\%$ of the number of values used to both compute the transfer function and $\cl$.  

For the integrand in \figref{fig:M4:results:integrand_thetas} we have plotted for $\ell=20,\,200$ and $300$, and used a scaling of $\ell(\ell+1)$, just as we did for $\cl$, to better compare the different values. Towards higher $k$, it's evident that a high resolution is needed to obtain an accurate result. We note that all integrands die out very slowly, and a high resolution is thus important to sample the integrand properly upon integrating. Each graph peaks at $k\eta_0$ slightly larger than $\ell$, as expected from our previous discussions. This suggests that a natural way to increase numerical efficiency would be to omit the lower $k$-values when computing the source function for a given $\ell$. Comparing with Fig. 4 in \citeauthor{callin}, we get a reasonably good agreement, regarding the overall shape and evolution of the integrands.             
\begin{figure}[ht!]
    \includefig{integrand_thetas\pspecresolution\ellintegrand}
    \caption{The term involved in the integrand of \Eqref{eq:M4:theory:CMB_power_spectrum}, for different values of $\ell$. Note that we scale each integrand by $\ell(\ell+1)$, just as we did for $\cl$. This is done to see each of the terms simultaneously.}
    \label{fig:M4:results:integrand_thetas}
\end{figure}

In \figref{fig:M4:results:thetas}, the aforementioned sampling issue is highly noticeable, with $N=2000$ causing clear sampling issues. The sampling used in the actual computations seems to give reasonable results, based on \figref{fig:M4:results:integrand_thetas}, which does not show such prominent sampling issues. From the shape of the transfer functions alone, it appears that increasing the sampling by a factor of $10$ could yield appropriate results. 

\begin{figure}[ht!]
    \includefig{thetas\pspecresolution\ellthetas}
    \caption{The transfer function from \Eqref{eq:M4:theory:Theta_ell_LOS_integration} plotted for different values of $\ell$.}
    \label{fig:M4:results:thetas}
\end{figure}