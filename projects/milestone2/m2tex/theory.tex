

\subsection{Theory}\label{ssec:M2:theory}

\subsubsection{Optical depth and visibility function} \label{sssec:M2:optical_depth_and_visibility_function}

A source that emits light with an intensity $I_0$ is attenuated by a factor $e^{-\tau(x)}$ as it travels through a medium, where $\tau$ is the optical depth of the medium. In the early universe we have $\tau\gg1$, and the universe is said to be optically thick. As the universe expands and recombination takes place, the universe becomes optically thin, $\tau\ll1$, and light is able to escape the primordial plasma and reach us. Considering Thompson scattering only, the optical depth is defined in terms of the scale factor, $a$, as \citep[Eq. (5)]{callin} 
\begin{equation} \label{eq:M2:theory:optical_depth_integral_definition}
    \tau(\eta) = \int_\eta^{\eta_0} \dd \eta' \,\ne \sigma_T a,
\end{equation}
where $\ne$ is the number density of free electrons,
\begin{equation} \label{eq:M2:theory:thomspon_cross_section}
    \sigma_T=\frac{8\pi\alpha^2}{3 m_e^2} = 6.6524587158\cdot 10^{-29}\unit{m^2} 
\end{equation}
is the Thompson cross-section and $a$ is the scale factor. $\alpha$ is the fine-structure constant and $m_e$ is the electron mass. Using \Eqref{eq:M1:theory:eta_ODE}, we can rewrite \Eqref{eq:M2:theory:optical_depth_integral_definition} as a differential equation 
\begin{equation} \label{eq:M2:theory:tau_ODE}
    \dv{\tau}{x} = - \frac{\ne \sigma_T}{H},
\end{equation}
which we can solve numerically once we know $n_e$. The initial condition is $\tau(x=0)=0$, as we then integrate over a medium of zero extent. The quantity $\tau'$ can loosely be viewed as a cosmological scattering rate, as it gives a measure of the number of scatterings a photon undergoes over the course of a Hubble time $H^{-1}$. In \secref{sec:M4} we discuss how this quantity is crucial to understanding small scale features of the CMB.   

From the optical depth, we obtain the so-called \textit{visibility function} \cite[Eq. (8)]{callin} 
\begin{equation} \label{eq:M2:theory:g_tilde_of_x_definition}
    \gx = -\tau' e^{-\tau},
\end{equation}
which has the property 
\begin{equation} \label{eq:M2:theory:g_tilde_normalization}
    \int_{-\infty}^0\dd x\,\gx = 1.
\end{equation}
This implies that $\gx$ can be interpreted a probability distribution, namely the probability of an observed CMB photon today having experienced its last scattering at a time $x$. The visibility function is sharply peaked around the time when the photons decouple from the baryons, and is often referred to as the surface of last scattering. We may therefore use the peak of $\gx$ to estimate the time when decoupling took place in the early universe. The time when recombination and decoupling takes place marks the time of when the Universe became transparent. In the very early Universe, the optical depth was high, meaning that no photons were tightly coupled to baryons, and thus not able to travel unimpeded. The time of decoupling thus marks the earliest period of the Universe that we are able to observe today. The CMB photons we observe today is therefore light emerging from the plasma at a time when $\tau\sim1$. How the optical depth evolves is thus crucial to understand and compute the evolution of the early Universe, which is the topic of the next two sections.   

\subsubsection{Electron density} \label{sssec:M2_electron_density}
The final thing we need to compute $\tau$ and $\g$ is the number density of free electrons. To compute the evolution of free electrons, we have to consider the Boltzmann equation \citep[Eq. (3.19)]{Dodelson}
\begin{equation} \label{eq:M2:theory:Boltzmann_equation}
    \dv{f}{t} = C[f],
\end{equation}
where $f$ is the distribution function and $C[f]$ is a collision term. 

We will consider the zeroth order of the Boltzmann equation, which is the relevant equation for the scope of our analysis of recombination. Following the notation and definitions from \cite[Eq. (4.5)-(4.9)]{Dodelson}, the equation we consider is given as  
\begin{equation} \label{eq:M2:theory:Boltzmann_equation_four_particles_scale_factor}
    a^{-3}\dv{(n_1 a^3)}{t} = \equilibriumn[1] \equilibriumn[2] \expval{\sigma v} \BBclosed{\frac{n_3 n_4}{\equilibriumn[3] \equilibriumn[4]} - \frac{n_1 n_2}{\equilibriumn[1] \equilibriumn[2]}},
\end{equation}
where $n_i$ denotes the number density of a particle species $i$, with $\equilibriumn[i]$ referring to its value in chemical equilibrium, and $\expval{\sigma v}$ is the thermally averaged cross-section. The only reaction we will consider for recombination is   
\begin{equation} \label{eq:M2:theory:electron_proton_to_hydrogen_photon}
    e^- + p^+ \leftrightarrow H + \gamma.
\end{equation}   
For the photons we will assume $n_\gamma = \equilibriumn[\gamma]$. From now on we use $e$ and $p$ as subscripts to denote free electrons and protons, respectively, and a subscript $H$ to denote neutral Hydrogen. 

Instead of computing $\ne$ directly, we will compute the fractional electron density
\begin{equation} \label{eq:M2:theory:X_e_definition}
    \Xe \equiv \frac{n_e}{n_e + n_H} \approx \frac{\ne}{n_b},
\end{equation}
where $n_b$ is the total baryon density of the universe. Since the universe must be electrically neutral, we have $n_e=n_p$, and assuming no heavier elements than Hydrogen gives $n_b\approx n_p+n_H$. Neglecting the small mass difference between the proton and the Hydrogen, the baryon density can be written as    
\begin{equation} \label{eq:M2:theory:helium_baryon_number_density}
    n_b \approx \frac{\rho_b}{m_H} = \frac{\obn \rhocn}{m_H a^3},
\end{equation}
where $\rhocn\equiv \frac{3 H_0^2}{8\pi G}$ is the critical density of the universe today and $m_H$ is the Hydrogen mass. 

Before recombination occurs, the interaction rates greatly exceed the expansion rate of the universe, and for \Eqref{eq:M2:theory:Boltzmann_equation_four_particles_scale_factor} to be valid we must have that 
\begin{equation} \label{eq:M2:theory:Boltzmann_equation_recombination_approximation}
    \frac{n_e n_p}{n_H} = \frac{\equilibriumn[e]\equilibriumn[p]}{\equilibriumn[H]}.
\end{equation}
In terms of $\Xe$, this reduces to the Saha equation 
\begin{equation} \label{eq:M2:theory:saha_equation}
    \frac{\Xe^2}{1-\Xe} = \frac{1}{n_b} \pclosed{\frac{m_e \Tb}{2\pi}}^{3/2} e^{-\epsn / \Tb},
\end{equation}
where $\Tb$ is the temperature of the baryons, and $\epsn$ is the Hydrogen ionization energy. The time evolution of $\Tb$ is governed by a differential equation coupled to $\Xe$. However, we will assume that it follows the photon temperature, $T_\gamma$, evolving as  
\begin{equation} \label{eq:M2:theory:baryon_temperature_evolution}
    \Tb = T_\gamma = \tcmb e^{-x}.
\end{equation}
%==
At later times, \Eqref{eq:M2:theory:Boltzmann_equation_recombination_approximation} is no longer a valid approximation, and we have to solve \Eqref{eq:M2:theory:Boltzmann_equation_four_particles_scale_factor}. Additionally, we have to take processes related to atomic physics into account, so the differential equation we will consider is the Peebles equation  
\begin{equation} \label{eq:M2:theory:Xe_peebles_ODE}
    \dv{\Xe}{x} = \frac{C_r(\Tb)}{H}\bclosed{\beta(\Tb)(1-\Xe) - n_H \alpha^{(2)}(\Tb) \Xe^2 },
\end{equation}
where $C_r(\Tb),\: \beta(\Tb)$ and $\alpha^{(2)}(\Tb)$ are quantities related to interaction effects, and are given by 
\begin{subequations} \label{eq:M2:theory:peebles:ODE_all_individual_terms}
    \begin{align}
        C_r(\Tb) &= \frac{\Lambda_{2s\to1s} + \Lambda_\alpha}{\Lambda_{2s\to1s} + \Lambda_\alpha + \beta^{(2)}(\Tb)}, \label{eq:M2:theory:peebles:C_r} \\
        \Lambda_{2s\to1s} &= 8.227\unit{s^{-1}}, \label{eq:M2:theory:peebles:Lambda_2s_1s} \\
        \Lambda_\alpha &= H \frac{(3\epsn)^3}{(8\pi)^2 n_{1s}}, \label{eq:M2:theory:peebles:Lambda_alpha} \\
        n_{1s} &= (1-\Xe) n_H , \label{eq:M2:theory:peebles:n_1s} \\
        \beta^{(2)}(\Tb) &= \beta(\Tb) e^{3\epsn/4\Tb}, \label{eq:M2:theory:peebles:beta2} \\
        \beta(\Tb) &= \alpha^{(2)}(\Tb) \pclosed{\frac{m_e \Tb}{2\pi}}^{3/2} e^{-\epsn/\Tb}, \label{eq:M2:theory:peebles:beta} \\
        \alpha^{(2)} &= \frac{64\pi}{\sqrt{27\pi}} \frac{\alpha^2}{m_e^2} \sqrt{\frac{\epsn}{\Tb}} \phi_2(\Tb), \label{eq:M2:theory:peebles:alpha_2} \\
        \phi_2(\Tb) &= 0.448\ln(\epsn/\Tb). \label{eq:M2:theory:peebles:phi_2} 
    \end{align}
\end{subequations}
The main reason behind these additional equations is that Hydrogen production is inefficient at $\Tb\simeq\epsn$. Direct recombination to the Hydrogen ground state is likely to produce a photon with energy greater than $\epsn$, which will ionize another nearby Hydrogen atom, resulting in no net Hydrogen production. Recombination is achieved when an electron and proton combine to an excited Hydrogen atom, followed by the atom's decay into the ground state, which is a slow process. 

In \secref{sssec:M2:implementations:solving_peebles} we discuss how combine the Saha and Peebles equation to compute $\Xe$.

\subsubsection{Sound Horizon at decoupling} \label{sssec:M2:sound_horizon}
Before recombination happens, baryons and photons are tightly coupled. For this reason, the baryons and photons behave as if they were a single fluid, and the sound speed of this fluid is given by \cite[Eq. (9.21)]{Dodelson} (where we use $R\to 1/R$)
\begin{equation} \label{eq:M2:theory:soundspeed_R_baryons_and_photons}
    c_s(x) = \frac{c}{\sqrt{3}} \sqrt{\frac{R(x)}{1+R(x)}},\quad R(x) = \frac{4\og(x)}{3\ob(x)}.
\end{equation}
The total co-moving distance a sound wave in this plasma could have travelled since the Big Bang is known as the sound-horizon, which is given as 
\begin{equation} \label{eq:M2:theory:sound_horizon_integral}
    s(x)=\int_{-\infty}^x \frac{\dd x' c_s}{\H}.
\end{equation}
From this we can compute the sound horizon at decoupling, $r_s = s(x\rec)$, which is an important quantity of the CMB. Thus, we have an additional ODE to solve, 
\begin{equation} \label{eq:M2:theory:sound_horizon_ODE}
    \dv{s(x)}{x} = \frac{c_s}{\H},
\end{equation}
with $s(x_\mathrm{ini})=\frac{c_s(x_\mathrm{ini})}{\H(x_\mathrm{ini})}$ as the initial condition, following the same reasoning as we did for $\eta'(x)$ in \Eqref{eq:M1:theory:eta_of_xstart_analytical_approximation}.
