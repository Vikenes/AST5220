\subsection{Implementation details}\label{ssec:M3:implementations} 
\subsubsection{Tight coupling regime} \label{sssec:M3:implementations:tight_coupling_regime}
During tight coupling, \Eqref{eq:M3:implementations:TC_ODEs_Theta_1} needs to be modified to avoid numerically instability at early times. Following \citeauthor{callin}, the tight coupling regime is computed with 
\begin{subequations} \label{eq:M3:implementations:TC_ODEs}
    \begin{align}
        \varrho q =& -[(1-R)\tau' + (1+R)\tau''](3\Theta_1 + \vb) \nonumber \\
            & -\koverhp\Psi + (1-\frac{\H'}{\H})\koverhp(-\Theta_0 + 2\Theta_2) - \koverhp\Theta_0', \label{eq:M3:implementations:TC_ODEs_q} \\
        \vb' =& \frac{1}{1+R}\bclosed{-\vb-\koverhp\Psi + R(q+\koverhp[-\Theta_0+2\Theta_2-\Psi])}, \label{eq:M3:implementations:TC_ODEs_v_b} \\
        \Theta_1' =& \frac{1}{3}(q-\vb'), \label{eq:M3:implementations:TC_ODEs_Theta_1} 
    \end{align}
\end{subequations} 
where we have introduced the parameter 
\begin{equation} \label{eq:M3:implementations:q_prefactor}
    \varrho = (1+R)\tau' + \frac{\H'}{\H} - 1.
\end{equation}
In the tight coupling regime we use the initial conditions given in \Eqref{eq:M3:theory:pert_ODE_IC}. We then solve the ODEs given in \Eqref{eq:M3:theory:perturbation_ODEs}, but compute $\Theta_1'$ and $v_b'$ in the end by using \Eqref{eq:M3:implementations:TC_ODEs}. In this regime we use Eqs. \Eqref{eq:M3:theory:IC_Theta2} and \eqref{eq:M3:theory:IC_Theta_ell} for $\Theta_2$ and $\Theta_\ell$, respectively. 

Next, we need to determine when the tight coupling approximation is valid. We use the same conditions as \citeauthor{callin}, namely that the approximation holds as long as $\abs{\tau'}>10$ and $\abs{k/\H\tau'}<1/10$, and that it should not be used after the start of recombination. For the latter condition, we choose $x<-8.3$ as the time when recombination starts. If any of these three conditions fails, we switch to the full ODEs. We then use the final results from the tight coupling regime as initial conditions for the ODEs in \Eqref{eq:M3:theory:perturbation_ODEs}, and integrate up to $x=0$. 

\subsubsection{Integration details \pnote{working title}} \label{sssec:M3:implementations:integration_details}
\note{Write about details regarding integration}

When solving the perturbation ODEs we integrate across $x$ for each mode $k$, where we choose $N_k=100$ values of $k\in[5\cdot10^{-5},\,0.3]/\mathrm{Mpc}$ values. For the highest multipole, we choose $\ell_\mathrm{max}=7$. As previously mentioned, we only use the higher multipoles to get an accurate result for $\Theta_0-\Theta_2$. Higher multipoles are therefore not splined.     


\subsubsection{Source function} \label{sssec:M3:implementations:source_function}
For the source function, we use values of $N_k=100$ values of $k$ in the same range as before, but now distributed quadratically 
\begin{equation} \label{eq:M3:implementations:k_distribution_for_source_function}
    k_i = k_\mathrm{min} + (k_\mathrm{max} - k_\mathrm{min})(i/N_k)^2,
\end{equation}